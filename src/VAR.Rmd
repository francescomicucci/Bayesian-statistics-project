---
title: "VAR"
output: html_notebook
---

```{r}
# Load libraries
rm(list=ls())
library(rjags)
library(bayesplot)
library(jagsUI)
library(kdensity)
library(vars)
library(loo)
```

```{r}
# Load data
data = read.csv("../dataset/gdp_inflation.csv", header=T)
data$DATE         = as.Date(data$DATE)
data$GDP_PC1      = as.numeric(data$GDP_PC1)
data$CPIAUCSL_PC1 = as.numeric(data$CPIAUCSL_PC1)
```

### VAR(1)
```{r}
# Define model in JAGS
modelVAR.string <-"model {
  # Likelihood
  Yp[1:2, 1] <- Y[1:2, 1]
  mu[1:2, 1] <- Y[1:2, 1]
  for (i in 2:N) {
    Y[1:2, i]  ~ dmnorm(mu[1:2, i], tau[1:2, 1:2])
    Yp[1:2, i] ~ dmnorm(mu[1:2, i], tau[1:2, 1:2])   # Prediction in sample 
    mu[1,i]    <- m0[1] + alpha[1,1] * Y[1,i-1] + alpha[1,2] * Y[2,i-1]
    mu[2,i]    <- m0[2] + alpha[2,1] * Y[1,i-1] + alpha[2,2] * Y[2,i-1]
    LogLik[i]  <- logdensity.mnorm(Y[1:2, i], mu[1:2, i], tau[1:2, 1:2])
  }
  
  # Prediction out of sample 
  ypOut[1:2, 1]  ~ dmnorm(muOut[1:2, 1], tau[1:2, 1:2])
  muOut[1,1]     <- m0[1] + alpha[1,1] * Y[1,N] + alpha[1,2] * Y[2,N]
  muOut[2,1]     <- m0[2] + alpha[2,1] * Y[1,N] + alpha[2,2] * Y[2,N]
  for (k in 2:Npred) {
    ypOut[1:2, k] ~ dmnorm(muOut[1:2, k], tau[1:2, 1:2])
    muOut[1,k]    <- m0[1] + alpha[1,1] * ypOut[1,k-1] + alpha[1,2] * ypOut[2,k-1]
    muOut[2,k]    <- m0[2] + alpha[2,1] * ypOut[1,k-1] + alpha[2,2] * ypOut[2,k-1]
  }
  
  cov.matrix <- inverse(tau)
  
  # Prior 
  for(j in 1:2) {
    for(h in 1:2) {
      alpha[j, h] ~ dunif(-1, 1)
    }
    m0[j]  ~ dnorm(0.0, 1.0E-4)
  }
  
  tau ~ dwish(R,k)
  
  k <- 3
  R[1,1] <- 1.0
  R[1,2] <- 0.5
  R[2,1] = R[1,2]
  R[2,2] <- 1.0
  
}"
```

```{r}
# Prepare data
Ntot  = dim(data)[1]
Npred = round(0.1 * Ntot) # Horizon for out-of-sample prediction
N     = Ntot - Npred

data_subsample = data[1:N, ]

line_data <- list("N" = N,
                  "Npred" = Npred,
                  "Y" = t(data_subsample[,2:3]))

# JAGS
outputmcmcVAR <- jags(model.file = textConnection(modelVAR.string),
                      data = line_data,
                      parameters.to.save= c("alpha", "cov.matrix", "m0", "Yp", "ypOut", "LogLik"), 
                      n.adapt=500, n.iter=3000, n.chains = 3, n.burnin = 500)
```

```{r}
# WAIC, DIC
WAIC <- waic(outputmcmcVAR$sims.list$LogLik[,-1])
DIC  <- outputmcmcVAR$DIC
WAIC
DIC
```

```{r}
# Plots
mcmc_trace(outputmcmcVAR$samples, pars = c("alpha[1,1]"))
mcmc_areas(outputmcmcVAR$samples, pars = c("alpha[1,1]"),  prob = 0.95)
mcmc_trace(outputmcmcVAR$samples, pars = c("alpha[1,2]"))
mcmc_areas(outputmcmcVAR$samples, pars = c("alpha[1,2]"),  prob = 0.95)
mcmc_trace(outputmcmcVAR$samples, pars = c("alpha[2,1]"))
mcmc_areas(outputmcmcVAR$samples, pars = c("alpha[2,1]"),  prob = 0.95)
mcmc_trace(outputmcmcVAR$samples, pars = c("alpha[2,2]"))
mcmc_areas(outputmcmcVAR$samples, pars = c("alpha[2,2]"),  prob = 0.95)
mcmc_trace(outputmcmcVAR$samples, pars = c("cov.matrix[1,1]"))
mcmc_areas(outputmcmcVAR$samples, pars = c("cov.matrix[1,1]"),  prob = 0.95)
mcmc_trace(outputmcmcVAR$samples, pars = c("cov.matrix[2,2]"))
mcmc_areas(outputmcmcVAR$samples, pars = c("cov.matrix[2,2]"),  prob = 0.95)
mcmc_trace(outputmcmcVAR$samples, pars = c("cov.matrix[1,2]"))
mcmc_areas(outputmcmcVAR$samples, pars = c("cov.matrix[1,2]"),  prob = 0.95)

autocorr.plot(outputmcmcVAR$samples[,c("alpha[1,1]")],main="alpha_11")
autocorr.plot(outputmcmcVAR$samples[,c("alpha[1,2]")],main="alpha_12")
autocorr.plot(outputmcmcVAR$samples[,c("alpha[2,1]")],main="alpha_21")
autocorr.plot(outputmcmcVAR$samples[,c("alpha[2,2]")],main="alpha_22")
autocorr.plot(outputmcmcVAR$samples[,c("cov.matrix[1,1]")],main="cov.matrix_11")
autocorr.plot(outputmcmcVAR$samples[,c("cov.matrix[2,2]")],main="cov.matrix_22")
autocorr.plot(outputmcmcVAR$samples[,c("cov.matrix[1,2]")],main="cov.matrix_12")
```

```{r}
t  = seq(1,Ntot)
tt = seq(1,N)

yp      = outputmcmcVAR$mean$Yp[1,]
q1      = outputmcmcVAR$q2.5$Yp[1,]
q2      = outputmcmcVAR$q97.5$Yp[1,]
yp_pred = outputmcmcVAR$mean$ypOut[1,]
q1_pred = outputmcmcVAR$q2.5$ypOut[1,]
q2_pred = outputmcmcVAR$q97.5$ypOut[1,]

# Plot
plot(t, data$GDP_PC1, col="black", ylab="mu_t", ylim=c(-7.0, 24),
     type="l", main= "Prediction GDP_PC1")
points(tt, yp, pch="*", col="red")
polygon(c(tt, rev(tt)), c(q1, rev(q2)), col = rgb(1, 0, 0, 0.3), border = NA)
points(seq((N+1),Ntot,1), pch="*", yp_pred, col="blue")
polygon(c(seq((N+1),Ntot,1), rev(seq((N+1),Ntot,1))), 
        c(q1_pred, rev(q2_pred)), col = rgb(0, 0, 1, 0.3), border = NA)
legend("topright", lty = 0, bty="n", cex=0.8, pch = 19,
       xpd=TRUE, inset=c(0.005,0),
       legend = c("Dataset", "In-sample preditction", "Out-of-sample prediction"), 
       col = c("black", "red", "blue"))
```

```{r}
# VAR model using VAR function
var_model <- VAR(data_subsample[,2:3], p=1, type="const")
var_fit   <- fitted(var_model)
summary(var_model)
coef(var_model)
# Plot 1 (JAGS vs VAR function)
plot(tt, yp, type="p", pch="*", col="blue", main="JAGS vs VAR function",
     xlab="Time", ylab="y_p")
points(var_fit[,1], type = "l", col = "red", lty = 2)
legend("topright", legend = c("JAGS", "VAR function"),
       col = c("blue", "red"), lty = 1)

# Plot 2 (Prediction VAR function)
prediction <- predict(var_model, n.ahead = 30)
ts.plot(data$GDP_PC1, ylab="y_t", main="VAR function vs True data")
points(var_fit[,1], type = "l", col = 2, lty = 2)
points(276:305, prediction$fcst$GDP_PC1[,1], type = "l", col = 'green2', lty = 2)

# Plot posterior of alpha[1,1]
a11.mcmc.mat=as.matrix(outputmcmcVAR$samples[,c("alpha[1,1]")], iters = FALSE)
ya11=kdensity(a11.mcmc.mat)
plot(ya11,main="Posterior of alpha[1,1]")
abline(v=outputmcmcVAR$mean$alpha[1,1],col="blue")
abline(v=coef(var_model)$GDP_PC1[1,1],col="red")
legend("topright", legend = c("JAGS", "VAR"),
       col = c("blue", "red"), lty = 1)

# Plot posterior of alpha[1,2]
a12.mcmc.mat=as.matrix(outputmcmcVAR$samples[,c("alpha[1,2]")], iters = FALSE)
ya12=kdensity(a12.mcmc.mat)
plot(ya12,main="Posterior of alpha[1,2]")
abline(v=outputmcmcVAR$mean$alpha[1,2],col="blue")
abline(v=coef(var_model)$GDP_PC1[2,1],col="red")
legend("topright", legend = c("JAGS", "VAR"),
       col = c("blue", "red"), lty = 1)

```

```{r}
t  = seq(1,Ntot)
tt = seq(1,N)

yp      = outputmcmcVAR$mean$Yp[2,]
q1      = outputmcmcVAR$q2.5$Yp[2,]
q2      = outputmcmcVAR$q97.5$Yp[2,]
yp_pred = outputmcmcVAR$mean$ypOut[2,]
q1_pred = outputmcmcVAR$q2.5$ypOut[2,]
q2_pred = outputmcmcVAR$q97.5$ypOut[2,]

# Plot
plot(t, data$CPIAUCSL_PC1, col="black", ylab="mu_t", ylim=c(-7.0, 17),
     type="l", main= "Prediction CPIAUCSL_PC1")
points(tt, yp, pch="*", col="red")
polygon(c(tt, rev(tt)), c(q1, rev(q2)), col = rgb(1, 0, 0, 0.3), border = NA)
points(seq((N+1),Ntot,1), pch="*", yp_pred, col="blue")
polygon(c(seq((N+1),Ntot,1), rev(seq((N+1),Ntot,1))), 
        c(q1_pred, rev(q2_pred)), col = rgb(0, 0, 1, 0.3), border = NA)
legend("topright", lty = 0, bty="n", cex=0.8, pch = 19,
       xpd=TRUE, inset=c(0.005,0),
       legend = c("Dataset", "In-sample preditction", "Out-of-sample prediction"), 
       col = c("black", "red", "blue"))
```

```{r}
# VAR model using VAR function
var_model <- VAR(data_subsample[,2:3], p=1, type="const")
var_fit   <- fitted(var_model)
summary(var_model)

# Plot 1 (JAGS vs VAR function)
plot(tt, yp, type="p", pch="*", col="blue", main="JAGS vs VAR function",
     xlab="Time", ylab="y_p")
points(var_fit[,2], type = "l", col = "red", lty = 2)
legend("topright", legend = c("JAGS", "VAR function"),
       col = c("blue", "red"), lty = 1)

# Plot 2 (Prediction VAR function)
prediction <- predict(var_model, n.ahead = 30)
ts.plot(data$CPIAUCSL_PC1, ylab="y_t", main="VAR function vs True data")
points(var_fit[,2], type = "l", col = 2, lty = 2)
points(276:305, prediction$fcst$CPIAUCSL_PC1[,1], type = "l", col = 'green2', lty = 2)

# Plot posterior of alpha[2,1]
a21.mcmc.mat=as.matrix(outputmcmcVAR$samples[,c("alpha[2,1]")], iters = FALSE)
ya21=kdensity(a21.mcmc.mat)
plot(ya21,main="Posterior of alpha[2,1]")
abline(v=outputmcmcVAR$mean$alpha[2,1],col="blue")
abline(v=coef(var_model)$CPIAUCSL_PC1[1,1],col="red")
legend("topright", legend = c("JAGS", "VAR"),
       col = c("blue", "red"), lty = 1)

# Plot posterior of alpha[2,2]
a22.mcmc.mat=as.matrix(outputmcmcVAR$samples[,c("alpha[2,2]")], iters = FALSE)
ya22=kdensity(a22.mcmc.mat)
plot(ya22,main="Posterior of alpha[2,2]")
abline(v=outputmcmcVAR$mean$alpha[2,2],col="blue")
abline(v=coef(var_model)$CPIAUCSL_PC1[2,1],col="red")
legend("topright", legend = c("JAGS", "VAR"),
       col = c("blue", "red"), lty = 1)
```
