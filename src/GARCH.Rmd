---
title: "GARCH"
output: html_document
---

```{r}
rm(list=ls())
library(rjags)
library(bayesplot)
library(jagsUI)
```

```{r}
# Load data
data = read.csv("../Dataset/gdp_inflation.csv", header=T)
data$DATE         = as.Date(data$DATE)
data$GDP_PC1      = as.numeric(data$GDP_PC1)
data$CPIAUCSL_PC1 = as.numeric(data$CPIAUCSL_PC1)
```

```{r}
modelGARCH.string <-"model {
  ## Parameters:
  # Likelihood
  Y[1]  ~ dnorm(m0, tau[1])
  Yp[1] ~ dnorm(m0, tau[1])
  tau[1]    <- 1 / sigma2[1]
  sigma2[1] <- a[1]
  eps2[1]   <- (Y[1] - m0) * (Y[1] - m0)
  for(i in 2:N) {
    Y[i]      ~ dnorm(Y[i-1], tau[i])
    Yp[i]     ~ dnorm(Y[i-1], tau[i])      # Prediction in sample
    tau[i]    <- 1 / sigma2[i]
    sigma2[i] <- a[1] + a[2] * eps2[i-1] + a[3] * sigma2[i-1]
    eps2[i]   <- (Y[i] - Y[i-1]) * (Y[i] - Y[i-1])
  }
  
  # Prediction out of sample 
  ypOut[1]     ~  dnorm(Y[N], tauOut[1])
  tauOut[1]    <- 1 / sigma2Out[1]
  sigma2Out[1] <- a[1] + a[2] * eps2[N] + a[3] * sigma2[N]
  eps2Out[1]   <- (ypOut[1] - Y[N]) * (ypOut[1] - Y[N])
  for (k in 2:Npred) {
    ypOut[k]     ~  dnorm(ypOut[k-1], tauOut[k])
    tauOut[k]    <- 1 / sigma2Out[k]
    sigma2Out[k] <- a[1] + a[2] * eps2Out[k-1] + a[3] * sigma2Out[k-1]
    eps2Out[k]   <- (ypOut[k] - ypOut[k-1]) * (ypOut[k] - ypOut[k-1])
  }
  
  # Prior 
  for(j in 1:3) {
    a[j] ~ dgamma(9.0, 2.0)
  }
  m0 ~ dnorm(0.0, 1.0E-4)
}"
```

```{r}
# Prepare data
Ntot  = dim(data)[1]
Npred = round(0.1 * Ntot) # Horizon for out-of-sample prediction
N     = Ntot - Npred

data_subsample = data[1:N, ]

line_data_GDP <- list("N" = N,
                      "Npred" = Npred,
                      "Y" = data_subsample$GDP_PC1)

outputmcmcARMA_GDP <- jags(model.file = textConnection(modelGARCH.string),
                         data = line_data_GDP,
                         parameters.to.save= c("a", "sigma2", "m0", "Yp", "ypOut"), 
                         n.adapt=1000, n.iter=10000, n.chains = 3, n.burnin = 1000)

line_data_CPIAUCSL <- list("N" = N,
                           "Npred" = Npred,
                           "Y" = data_subsample$CPIAUCSL_PC1)

outputmcmcARMA_CPIAUCSL <- jags(model.file = textConnection(modelGARCH.string),
                              data = line_data_CPIAUCSL,
                              parameters.to.save= c("a", "sigma2", "m0", "Yp", "ypOut"), 
                              n.adapt=1000, n.iter=10000, n.chains = 3, n.burnin = 1000)
```

```{r}
# mcmc_trace(outputmcmcARMA_GDP$samples, pars = c("a"))
# mcmc_areas(outputmcmcARMA_GDP$samples, pars = c("a"),  prob = 0.95)
# mcmc_trace(outputmcmcARMA_GDP$samples, pars = c("sigma2"))
# mcmc_areas(outputmcmcARMA_GDP$samples, pars = c("sigma2"),  prob = 0.95)

# autocorr.plot(outputmcmcARMA_GDP$samples[,c("a")],main="alpha GDP")
# autocorr.plot(outputmcmcARMA_GDP$samples[,c("sigma2")],main="sigma2 GDP")

# mcmc_trace(outputmcmcARMA_CPIAUCSL$samples, pars = c("a"))
# mcmc_areas(outputmcmcARMA_CPIAUCSL$samples, pars = c("a"),  prob = 0.95)
# mcmc_trace(outputmcmcARMA_CPIAUCSL$samples, pars = c("sigma2"))
# mcmc_areas(outputmcmcARMA_CPIAUCSL$samples, pars = c("sigma2"),  prob = 0.95)

# autocorr.plot(outputmcmcARMA_CPIAUCSL$samples[,c("a")],main="alpha CPIAUCSL")
# autocorr.plot(outputmcmcARMA_CPIAUCSL$samples[,c("sigma2")],main="sigma2 CPIAUCSL")
```

```{r}
t  = seq(1,Ntot)
tt = seq(1,N)

#
yp=outputmcmcARMA_GDP$mean$Yp
q1=outputmcmcARMA_GDP$q2.5$Yp
q2=outputmcmcARMA_GDP$q97.5$Yp

#
plot(t, data$GDP_PC1, col="red",ylab="mu_t",
     main="data (red), in samp.pred. (blue)")
lines(t, data$GDP_PC1,col="red")
points(tt, yp,pch="*", col="blue")
lines(tt, q1, type="l",col="blue", lwd = 1.5)
lines(tt, q2, type="l",col="blue", lwd = 1.5)

#
yp_pred=outputmcmcARMA_GDP$mean$ypOut
q1_pred=outputmcmcARMA_GDP$q2.5$ypOut
q2_pred=outputmcmcARMA_GDP$q97.5$ypOut

#
plot(t, data$GDP_PC1, col="red", ylab="mu_t", ylim=c(min(q1_pred),max(q2_pred)),
     main= "out-of-sample prediction (orange)")
abline(v=N,col="orange")
lines(tt, yp, type="p", pch="*", col="blue",)
lines(tt, q1, type="l", col="blue", lwd = 1.5)
lines(tt, q2, type="l", col="blue", lwd = 1.5)
points(seq((N+1),Ntot,1),pch="*",yp_pred,col="orange")
lines(seq((N+1),Ntot,1),q1_pred,col="orange",lwd = 1.5)
lines(seq((N+1),Ntot,1),q2_pred,col="orange",lwd = 1.5)
```

```{r}
t  = seq(1,Ntot)
tt = seq(1,N)

#
yp=outputmcmcARMA_CPIAUCSL$mean$Yp
q1=outputmcmcARMA_CPIAUCSL$q2.5$Yp
q2=outputmcmcARMA_CPIAUCSL$q97.5$Yp

#
plot(t, data$CPIAUCSL_PC1, col="red",ylab="mu_t",
     main="data (red), in samp.pred. (blue)")
lines(t, data$CPIAUCSL_PC1,col="red")
points(tt, yp,pch="*", col="blue")
lines(tt, q1, type="l",col="blue", lwd = 1.5)
lines(tt, q2, type="l",col="blue", lwd = 1.5)

#
yp_pred=outputmcmcARMA_CPIAUCSL$mean$ypOut
q1_pred=outputmcmcARMA_CPIAUCSL$q2.5$ypOut
q2_pred=outputmcmcARMA_CPIAUCSL$q97.5$ypOut

#
plot(t, data$CPIAUCSL_PC1, col="red", ylab="mu_t", ylim=c(min(q1_pred),max(q2_pred)),
     main= "out-of-sample prediction (orange)")
abline(v=N,col="orange")
lines(tt, yp, type="p", pch="*", col="blue",)
lines(tt, q1, type="l", col="blue", lwd = 1.5)
lines(tt, q2, type="l", col="blue", lwd = 1.5)
points(seq((N+1),Ntot,1),pch="*",yp_pred,col="orange")
lines(seq((N+1),Ntot,1),q1_pred,col="orange",lwd = 1.5)
lines(seq((N+1),Ntot,1),q2_pred,col="orange",lwd = 1.5)
```

```{r}
library(rugarch)
garch_spec <- ugarchspec(variance.model=list(model="sGARCH", garchOrder=c(1,1)), mean.model=list(armaOrder=c(0,0)))
fit_garch  <- ugarchfit(spec = garch_spec, data = data_subsample$GDP_PC1)
fit_garch
forecast = ugarchforecast(fit_garch, n.ahead=Npred, data=data_subsample$GDP_PC1)
fitted(forecast)
```