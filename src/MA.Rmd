---
title: "MA"
output: html_notebook
---


```{r}
rm(list=ls())

library(rjags)
library(bayesplot)
library(jagsUI)
library("kdensity")

```


Data loading and separation of the timeseries

```{r}
# Load data
data = read.csv("../Dataset/gdp_inflation.csv", header=T)
data$DATE         = as.Date(data$DATE)
data$GDP_PC1      = as.numeric(data$GDP_PC1)
data$CPIAUCSL_PC1 = as.numeric(data$CPIAUCSL_PC1)
```





```{r}
acf(data$GDP_PC1 [1:305], main="GDP ACF")
acf(data$CPIAUCSL_PC1[1:305], main='Inflation ACF')


```


```{r}
modelMA.string <-"model {
## Parameters: alpha, tau, m0
  # Likelihood 
  Yp[1] <- mu[1]
  mu[1] <- Y[1]
  eps[1] <- Y[1] - mu[1]
  for (i in 2:N) {
    Y[i] ~ dnorm(mu[i], tau)
    mu[i] <- m0 + theta * eps[i-1]
    eps[i] <- Y[i] - mu[i]
    Yp[i] ~ dnorm(mu[i], tau) 
  }
  
  # prediction out of sample 
  ypOut[1] ~dnorm(m0+theta*eps[N],tau) 
  muOut[1] <- m0+theta*eps[N]
  epsOut[1] <- ypOut[1] - muOut[1] 
  for(k in 2:Npred){
    ypOut[k] ~ dnorm(m0+theta*epsOut[k-1],tau) 
    muOut[k] <- m0+theta*epsOut[k-1]
    epsOut[k] <- ypOut[k] - muOut[k]
  }
  
  sigma2<-1/tau
  #prior 
  theta ~ dunif(-1.0, 1.0)
  tau ~ dgamma(2, 0.1)
  m0 ~ dnorm(0.0, 1.0E-4)
}"
```

```{r}
# Prepare data
Ntot  = dim(data)[1]
Npred = round(0.1 * Ntot) # Horizon for out-of-sample prediction
N     = Ntot - Npred

data_subsample = data[1:N, ]

line_data_GDP <- list("N" = N,
                      "Npred" = Npred,
                      "Y" = data_subsample$GDP_PC1)

outputmcmcMA_GDP <- jags(model.file = textConnection(modelMA.string),
                         data = line_data_GDP,
                         parameters.to.save= c("theta", "sigma2", "eps", "m0", "Yp", "ypOut"), 
                         n.adapt=1000, n.iter=10000, n.chains = 3, n.burnin = 3000)

line_data_CPIAUCSL <- list("N" = N,
                           "Npred" = Npred,
                           "Y" = data_subsample$CPIAUCSL_PC1)

outputmcmcMA_CPIAUCSL <- jags(model.file = textConnection(modelMA.string),
                              data = line_data_CPIAUCSL,
                              parameters.to.save= c("theta", "sigma2", "eps", "m0", "Yp", "ypOut"), 
                              n.adapt=1000, n.iter=10000, n.chains = 3, n.burnin = 3000)


```

```{r}
mcmc_trace(outputmcmcMA_GDP$samples, pars = c("theta"))
mcmc_areas(outputmcmcMA_GDP$samples, pars = c("theta"),  prob = 0.95)
mcmc_trace(outputmcmcMA_GDP$samples, pars = c("sigma2"))
mcmc_areas(outputmcmcMA_GDP$samples, pars = c("sigma2"),  prob = 0.95)

autocorr.plot(outputmcmcMA_GDP$samples[,c("theta")],main="theta GDP")
autocorr.plot(outputmcmcMA_GDP$samples[,c("sigma2")],main="sigma2 GDP")

mcmc_trace(outputmcmcMA_CPIAUCSL$samples, pars = c("theta"))
mcmc_areas(outputmcmcMA_CPIAUCSL$samples, pars = c("theta"),  prob = 0.95)
mcmc_trace(outputmcmcMA_CPIAUCSL$samples, pars = c("sigma2"))
mcmc_areas(outputmcmcMA_CPIAUCSL$samples, pars = c("sigma2"),  prob = 0.95)

autocorr.plot(outputmcmcMA_CPIAUCSL$samples[,c("theta")],main="theta CPIAUCSL")
autocorr.plot(outputmcmcMA_CPIAUCSL$samples[,c("sigma2")],main="sigma2 CPIAUCSL")
```

```{r}
t  = seq(1,Ntot)
tt = seq(1,N)

#
yp=outputmcmcMA_GDP$mean$Yp
q1=outputmcmcMA_GDP$q2.5$Yp
q2=outputmcmcMA_GDP$q97.5$Yp

#
plot(t, data$GDP_PC1, col="red",ylab="mu_t",
     main="data (red), in samp.pred. (blue)")
lines(t, data$GDP_PC1,col="red")
points(tt, yp,pch="*", col="blue")
lines(tt, q1, type="l",col="blue", lwd = 1.5)
lines(tt, q2, type="l",col="blue", lwd = 1.5)
#
yp_pred=outputmcmcMA_GDP$mean$ypOut
q1_pred=outputmcmcMA_GDP$q2.5$ypOut
q2_pred=outputmcmcMA_GDP$q97.5$ypOut

#
plot(t, data$GDP_PC1, col="red", ylab="mu_t",
     main= "out-of-sample prediction (orange)")
abline(v=N,col="orange")
lines(tt, yp, type="p", pch="*", col="blue",)
lines(tt, q1, type="l", col="blue", lwd = 1.5)
lines(tt, q2, type="l", col="blue", lwd = 1.5)
points(seq((N+1),Ntot,1),pch="*",yp_pred,col="orange")
lines(seq((N+1),Ntot,1),q1_pred,col="orange",lwd = 1.5)
lines(seq((N+1),Ntot,1),q2_pred,col="orange",lwd = 1.5)

```

```{r}
MA_gdp <- arima(data$GDP_PC1 [1:275], order = c(0,0,1))
print(MA_gdp)
MA_gdp_fit <- data$GDP_PC1 [1:275] - residuals(MA_gdp)

plot(tt, yp, type="p", pch="*", col="blue",)
points(MA_gdp_fit, type = "l", col = 2, lty = 2)

theta.mcmc.mat=as.matrix(outputmcmcMA_GDP$samples[,c("theta")], iters = FALSE)
ytheta=kdensity(theta.mcmc.mat)
plot(ytheta,main="posterior of theta")
abline(v=MA_gdp$coef[1],col="green")
abline(v=outputmcmcMA_GDP$mean$theta,col="blue")

predict_gdp <- predict(MA_gdp, n.ahead=30)
predict_gdp$pred
ts.plot(data$GDP_PC1)
points(MA_gdp_fit, type = "l", col = 2, lty = 2)
points(predict_gdp$pred, type = "l", col = 'orange', lty = 2)


```

```{r}
t  = seq(1,Ntot)
tt = seq(1,N)

#
yp=outputmcmcMA_CPIAUCSL$mean$Yp
q1=outputmcmcMA_CPIAUCSL$q2.5$Yp
q2=outputmcmcMA_CPIAUCSL$q97.5$Yp

#
plot(t, data$CPIAUCSL_PC1, col="red",ylab="mu_t",
     main="data (red), in samp.pred. (blue)")
lines(t, data$CPIAUCSL_PC1,col="red")
points(tt, yp,pch="*", col="blue")
lines(tt, q1, type="l",col="blue", lwd = 1.5)
lines(tt, q2, type="l",col="blue", lwd = 1.5)

#
yp_pred=outputmcmcMA_CPIAUCSL$mean$ypOut
q1_pred=outputmcmcMA_CPIAUCSL$q2.5$ypOut
q2_pred=outputmcmcMA_CPIAUCSL$q97.5$ypOut

#
plot(t, data$CPIAUCSL_PC1, col="red", ylab="mu_t", ylim=c(min(q1_pred),max(q2_pred)),
     main= "out-of-sample prediction (orange)")
abline(v=N,col="orange")
lines(tt, yp, type="p", pch="*", col="blue",)
lines(tt, q1, type="l", col="blue", lwd = 1.5)
lines(tt, q2, type="l", col="blue", lwd = 1.5)
points(seq((N+1),Ntot,1),pch="*",yp_pred,col="orange")
lines(seq((N+1),Ntot,1),q1_pred,col="orange",lwd = 1.5)
lines(seq((N+1),Ntot,1),q2_pred,col="orange",lwd = 1.5)
```

```{r}

MA_infl <- arima(data$CPIAUCSL_PC1 [1:275], order = c(0,0,1))
print(MA_infl)

MA_infl_fit <- data$CPIAUCSL_PC1 [1:275] - residuals(MA_infl)
plot(tt, yp, type="p", pch="*", col="blue",)
points(MA_infl_fit, type = "l", col = 2, lty = 2)

theta.mcmc.mat=as.matrix(outputmcmcMA_CPIAUCSL$samples[,c("theta")], iters = FALSE)
ytheta=kdensity(theta.mcmc.mat)
plot(ytheta,main="posterior of theta")
abline(v=MA_infl$coef[1],col="green")
abline(v=outputmcmcMA_CPIAUCSL$mean$theta,col="blue")

predict_infl <- predict(MA_infl, n.ahead=30)
predict_infl$pred
ts.plot(data$CPIAUCSL_PC1)
points(MA_infl_fit, type = "l", col = 2, lty = 2)
points(predict_infl$pred, type = "l", col = 'orange', lty = 2)
```

```{r}
modelMA_q2.string <-"model {
## Parameters: alpha, tau, m0
  # Likelihood 
  Yp[1] <- mu[1]
  mu[1] <- Y[1]
  eps[1] <- Y[1] - mu[1]
  Y[2] ~ dnorm(mu[2], tau)
  Yp[2] ~ dnorm(mu[2], tau)
  mu[2] <- m0 + theta_1 * eps[1]
  eps[2] <- Y[2] - mu[2]
  for (i in 3:N) {
    Y[i] ~ dnorm(mu[i], tau)
    mu[i] <- m0 + theta_1 * eps[i-1] + theta_2 * eps[i-2]
    eps[i] <- Y[i] - mu[i]
    Yp[i] ~ dnorm(mu[i], tau) 
  }
  
  # prediction out of sample 
  ypOut[1] ~dnorm(muOut[1],tau) 
  muOut[1] <- m0+theta_1*eps[N]+theta_2*eps[N-1]
  epsOut[1] <- ypOut[1] - muOut[1] 
  ypOut[2] ~dnorm(muOut[2],tau) 
  muOut[2] <- m0+theta_1*epsOut[1]+theta_2*eps[N]
  epsOut[2] <- ypOut[2] - muOut[2] 
  for(k in 3:Npred){
    ypOut[k] ~ dnorm(muOut[k],tau) 
    muOut[k] <- m0+theta_1*epsOut[k-1]+theta_2*epsOut[k-2]
    epsOut[k] <- ypOut[k] - muOut[k]
  }
  
  sigma2<-1/tau
  #prior 
  theta_1 ~ dunif(-1.5, 1.5)
  theta_2 ~ dunif(-1, 1)
  tau ~ dgamma(2, 0.1)
  m0 ~ dnorm(0.0, 1.0E-4)
}"
```

```{r}
# Prepare data
Ntot  = dim(data)[1]
Npred = round(0.1 * Ntot) # Horizon for out-of-sample prediction
N     = Ntot - Npred

data_subsample = data[1:N, ]

line_data_GDP <- list("N" = N,
                      "Npred" = Npred,
                      "Y" = data_subsample$GDP_PC1)

outputmcmcMA_GDP <- jags(model.file = textConnection(modelMA_q2.string),
                         data = line_data_GDP,
                         parameters.to.save= c("theta_1", "theta_2", "sigma2", "eps", "m0", "Yp", "ypOut"), 
                         n.adapt=1000, n.iter=10000, n.chains = 3, n.burnin = 3000)

line_data_CPIAUCSL <- list("N" = N,
                           "Npred" = Npred,
                           "Y" = data_subsample$CPIAUCSL_PC1)

outputmcmcMA_CPIAUCSL <- jags(model.file = textConnection(modelMA_q2.string),
                              data = line_data_CPIAUCSL,
                              parameters.to.save= c("theta_1", "theta_2", "sigma2", "eps", "m0", "Yp", "ypOut"), 
                              n.adapt=1000, n.iter=10000, n.chains = 3, n.burnin = 3000)
```

```{r}
mcmc_trace(outputmcmcMA_GDP$samples, pars = c("theta_1"))
mcmc_areas(outputmcmcMA_GDP$samples, pars = c("theta_1"),  prob = 0.95)
mcmc_trace(outputmcmcMA_GDP$samples, pars = c("theta_2"))
mcmc_areas(outputmcmcMA_GDP$samples, pars = c("theta_2"),  prob = 0.95)
mcmc_trace(outputmcmcMA_GDP$samples, pars = c("sigma2"))
mcmc_areas(outputmcmcMA_GDP$samples, pars = c("sigma2"),  prob = 0.95)

autocorr.plot(outputmcmcMA_GDP$samples[,c("theta_1")],main="theta 1 GDP")
autocorr.plot(outputmcmcMA_GDP$samples[,c("sigma2")],main="sigma2 GDP")
autocorr.plot(outputmcmcMA_GDP$samples[,c("theta_2")],main="theta 2 GDP")

mcmc_trace(outputmcmcMA_CPIAUCSL$samples, pars = c("theta_1"))
mcmc_areas(outputmcmcMA_CPIAUCSL$samples, pars = c("theta_1"),  prob = 0.95)
mcmc_trace(outputmcmcMA_CPIAUCSL$samples, pars = c("theta_2"))
mcmc_areas(outputmcmcMA_CPIAUCSL$samples, pars = c("theta_2"),  prob = 0.95)
mcmc_trace(outputmcmcMA_CPIAUCSL$samples, pars = c("sigma2"))
mcmc_areas(outputmcmcMA_CPIAUCSL$samples, pars = c("sigma2"),  prob = 0.95)

autocorr.plot(outputmcmcMA_CPIAUCSL$samples[,c("theta_1")],main="theta CPIAUCSL")
autocorr.plot(outputmcmcMA_CPIAUCSL$samples[,c("theta_2")],main="theta CPIAUCSL")
autocorr.plot(outputmcmcMA_CPIAUCSL$samples[,c("sigma2")],main="sigma2 CPIAUCSL")
```


```{r}
t  = seq(1,Ntot)
tt = seq(1,N)

#
yp=outputmcmcMA_GDP$mean$Yp
q1=outputmcmcMA_GDP$q2.5$Yp
q2=outputmcmcMA_GDP$q97.5$Yp

#
plot(t, data$GDP_PC1, col="red",ylab="mu_t",
     main="data (red), in samp.pred. (blue)")
lines(t, data$GDP_PC1,col="red")
points(tt, yp,pch="*", col="blue")
lines(tt, q1, type="l",col="blue", lwd = 1.5)
lines(tt, q2, type="l",col="blue", lwd = 1.5)
#
yp_pred=outputmcmcMA_GDP$mean$ypOut
q1_pred=outputmcmcMA_GDP$q2.5$ypOut
q2_pred=outputmcmcMA_GDP$q97.5$ypOut

#
plot(t, data$GDP_PC1, col="red", ylab="mu_t",
     main= "out-of-sample prediction (orange)")
abline(v=N,col="orange")
lines(tt, yp, type="p", pch="*", col="blue",)
lines(tt, q1, type="l", col="blue", lwd = 1.5)
lines(tt, q2, type="l", col="blue", lwd = 1.5)
points(seq((N+1),Ntot,1),pch="*",yp_pred,col="orange")
lines(seq((N+1),Ntot,1),q1_pred,col="orange",lwd = 1.5)
lines(seq((N+1),Ntot,1),q2_pred,col="orange",lwd = 1.5)
```


```{r}
MA_gdp_q2 <- arima(data$GDP_PC1 [1:275], order = c(0,0,2))
print(MA_gdp_q2)
MA_gdp_q2_fit <- data$GDP_PC1 [1:275] - residuals(MA_gdp_q2)
plot(tt, yp, type="p", pch="*", col="blue",)
points(MA_gdp_q2_fit, type = "l", col = 2, lty = 2)

theta.mcmc.mat=as.matrix(outputmcmcMA_GDP$samples[,c("theta_1")], iters = FALSE)
ytheta=kdensity(theta.mcmc.mat)
plot(ytheta,main="posterior of theta 1")
abline(v=MA_gdp_q2$coef[1],col="green")
abline(v=outputmcmcMA_GDP$mean$theta_1,col="blue")

theta.mcmc.mat=as.matrix(outputmcmcMA_GDP$samples[,c("theta_2")], iters = FALSE)
ytheta=kdensity(theta.mcmc.mat)
plot(ytheta,main="posterior of theta 2")
abline(v=MA_gdp_q2$coef[2],col="green")
abline(v=outputmcmcMA_GDP$mean$theta_2,col="blue")
```


```{r}
t  = seq(1,Ntot)
tt = seq(1,N)

#
yp=outputmcmcMA_CPIAUCSL$mean$Yp
q1=outputmcmcMA_CPIAUCSL$q2.5$Yp
q2=outputmcmcMA_CPIAUCSL$q97.5$Yp

#
plot(t, data$CPIAUCSL_PC1, col="red",ylab="mu_t",
     main="data (red), in samp.pred. (blue)")
lines(t, data$CPIAUCSL_PC1,col="red")
points(tt, yp,pch="*", col="blue")
lines(tt, q1, type="l",col="blue", lwd = 1.5)
lines(tt, q2, type="l",col="blue", lwd = 1.5)

#
yp_pred=outputmcmcMA_CPIAUCSL$mean$ypOut
q1_pred=outputmcmcMA_CPIAUCSL$q2.5$ypOut
q2_pred=outputmcmcMA_CPIAUCSL$q97.5$ypOut

#
plot(t, data$CPIAUCSL_PC1, col="red", ylab="mu_t", ylim=c(min(q1_pred),max(q2_pred)),
     main= "out-of-sample prediction (orange)")
abline(v=N,col="orange")
lines(tt, yp, type="p", pch="*", col="blue",)
lines(tt, q1, type="l", col="blue", lwd = 1.5)
lines(tt, q2, type="l", col="blue", lwd = 1.5)
points(seq((N+1),Ntot,1),pch="*",yp_pred,col="orange")
lines(seq((N+1),Ntot,1),q1_pred,col="orange",lwd = 1.5)
lines(seq((N+1),Ntot,1),q2_pred,col="orange",lwd = 1.5)
```

```{r}
MA_infl_q2 <- arima(data$CPIAUCSL_PC1 [1:275], order = c(0,0,2))
print(MA_infl_q2)
MA_infl_q2_fit <- data$CPIAUCSL_PC1 [1:275] - residuals(MA_infl_q2)
plot(tt, yp, type="p", pch="*", col="blue",)
points(MA_infl_q2_fit, type = "l", col = 2, lty = 2)

theta.mcmc.mat=as.matrix(outputmcmcMA_CPIAUCSL$samples[,c("theta_1")], iters = FALSE)
ytheta=kdensity(theta.mcmc.mat)
plot(ytheta,main="posterior of theta 1")
abline(v=MA_infl_q2$coef[1],col="green")
abline(v=outputmcmcMA_CPIAUCSL$mean$theta_1,col="blue")

theta.mcmc.mat=as.matrix(outputmcmcMA_CPIAUCSL$samples[,c("theta_2")], iters = FALSE)
ytheta=kdensity(theta.mcmc.mat)
plot(ytheta,main="posterior of theta 2")
abline(v=MA_infl_q2$coef[2],col="green")
abline(v=outputmcmcMA_CPIAUCSL$mean$theta_2,col="blue")
```